<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confluence Matrix Analysis - Dynamic Market Model</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .market-setup {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .setup-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .setup-card h3 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 1.1em;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .input-group input {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            color: #fff;
            font-size: 1em;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4CAF50;
            background: rgba(255,255,255,0.15);
        }
        
        .price-control {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #4CAF50;
        }
        
        .slider-control {
            margin-top: 20px;
        }
        
        .slider-group {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .slider-value {
            float: right;
            background: rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .calculated-values {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .value-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .value-card.positive {
            border-left-color: #4CAF50;
        }
        
        .value-card.negative {
            border-left-color: #f44336;
        }
        
        .value-card.neutral {
            border-left-color: #9E9E9E;
        }
        
        .value-label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .value-number {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .result-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .result-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .result-card h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        .score-display {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
        }
        
        .score-bar {
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }
        
        .score-fill {
            height: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .conditions-list {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .condition-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }
        
        .condition-item.met {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }
        
        .condition-item.not-met {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        
        .condition-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .condition-weight {
            margin-left: auto;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.85em;
        }
        
        .matrix-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .matrix-section h2 {
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .matrix-table th,
        .matrix-table td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85em;
        }
        
        .matrix-table th {
            background: rgba(255,255,255,0.15);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .matrix-table td.row-header {
            text-align: left;
            font-weight: 600;
            background: rgba(255,255,255,0.08);
            position: sticky;
            left: 0;
            z-index: 5;
        }
        
        .cell-strong-bull {
            background: rgba(76, 175, 80, 0.5);
            font-weight: bold;
        }
        
        .cell-bull {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .cell-neutral {
            background: rgba(158, 158, 158, 0.2);
        }
        
        .cell-bear {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .cell-strong-bear {
            background: rgba(244, 67, 54, 0.5);
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .legend-box {
            width: 25px;
            height: 20px;
            border-radius: 4px;
        }
        
        .info-banner {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        
        @media (max-width: 968px) {
            .result-panel {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .market-setup {
                grid-template-columns: 1fr;
            }
            
            .matrix-table {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Dynamic Confluence Matrix Analysis</h1>
        <p class="subtitle">Real-time Market Structure with Price-Dependent Calculations</p>
        
        <div class="info-banner">
            <strong>üìå How it works:</strong> Set your market structure (EMAs, daily levels, SuperTrend). Then move the CLOSE price slider to see how all distance metrics automatically recalculate based on their relationships. This simulates real market movement!
        </div>
        
        <div class="control-panel">
            <h2 style="margin-bottom: 20px;">üîß Market Structure Setup</h2>
            
            <div class="market-setup">
                <div class="setup-card">
                    <h3>üìä Moving Averages</h3>
                    <div class="input-group">
                        <label>EMA 26 (Short-term)</label>
                        <input type="number" id="ema26" value="100" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>EMA 252 (Long-term)</label>
                        <input type="number" id="ema252" value="95" step="0.1">
                    </div>
                </div>
                
                <div class="setup-card">
                    <h3>üìÖ Daily Levels</h3>
                    <div class="input-group">
                        <label>Yesterday's High</label>
                        <input type="number" id="daily_high" value="105" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Yesterday's Low</label>
                        <input type="number" id="daily_low" value="98" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Yesterday's Close</label>
                        <input type="number" id="daily_close" value="102" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>2 Days Ago Close</label>
                        <input type="number" id="prev_daily_close" value="101" step="0.1">
                    </div>
                </div>
                
                <div class="setup-card">
                    <h3>üéØ SuperTrend Levels</h3>
                    <div class="input-group">
                        <label>ST Support (st_min)</label>
                        <input type="number" id="st_min" value="99" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>ST Resistance (st_max)</label>
                        <input type="number" id="st_max" value="106" step="0.1">
                    </div>
                </div>
                
                <div class="setup-card">
                    <h3>üìà Volatility</h3>
                    <div class="input-group">
                        <label>ATR (TEMA)</label>
                        <input type="number" id="atr" value="2.0" step="0.1" min="0.1">
                    </div>
                </div>
            </div>
            
            <div class="slider-control">
                <div class="slider-group price-control">
                    <label>
                        üéöÔ∏è CURRENT CLOSE PRICE (Move to simulate market)
                        <span class="slider-value" id="val_close">102.0</span>
                    </label>
                    <input type="range" id="close_price" min="90" max="115" step="0.1" value="102">
                </div>
            </div>
        </div>
        
        <div class="calculated-values">
            <h2 style="margin-bottom: 20px;">üìê Calculated Distance Metrics (Auto-updated)</h2>
            <div class="values-grid" id="metrics-grid"></div>
        </div>
        
        <div class="result-panel">
            <div class="result-card">
                <h2>üü¢ Bullish Confluence</h2>
                <div class="score-display" id="bullish-score">0</div>
                <div class="score-bar">
                    <div class="score-fill" id="bullish-bar" style="width: 0%; background: linear-gradient(90deg, #4CAF50, #8BC34A);">0%</div>
                </div>
                <div class="conditions-list" id="bullish-conditions"></div>
            </div>
            
            <div class="result-card">
                <h2>üî¥ Bearish Confluence</h2>
                <div class="score-display" id="bearish-score">0</div>
                <div class="score-bar">
                    <div class="score-fill" id="bearish-bar" style="width: 0%; background: linear-gradient(90deg, #f44336, #e91e63);">0%</div>
                </div>
                <div class="conditions-list" id="bearish-conditions"></div>
            </div>
        </div>
        
        <div class="matrix-section">
            <h2>üìä Distance Correlation Matrix - Bullish Setups</h2>
            <p style="opacity: 0.9; margin-bottom: 15px; font-size: 0.95em;">
                Shows how each distance metric correlates with bullish conditions. Strong positive (++) means the metric strongly supports that condition.
            </p>
            <div style="overflow-x: auto;">
                <table class="matrix-table" id="bullish-matrix"></table>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-box cell-strong-bull"></div>
                    <span>Strong Support (++)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box cell-bull"></div>
                    <span>Support (+)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box cell-neutral"></div>
                    <span>Neutral (‚óã)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box cell-bear"></div>
                    <span>Conflict (-)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box cell-strong-bear"></div>
                    <span>Strong Conflict (--)</span>
                </div>
            </div>
        </div>
        
        <div class="matrix-section">
            <h2>üìâ Distance Correlation Matrix - Bearish Setups</h2>
            <p style="opacity: 0.9; margin-bottom: 15px; font-size: 0.95em;">
                Shows how each distance metric correlates with bearish conditions. Strong positive (++) means the metric strongly supports that condition.
            </p>
            <div style="overflow-x: auto;">
                <table class="matrix-table" id="bearish-matrix"></table>
            </div>
        </div>
    </div>
    
    <script>
        // Market structure variables
        let marketStructure = {
            ema26: 100,
            ema252: 95,
            daily_high: 105,
            daily_low: 98,
            daily_close: 102,
            prev_daily_close: 101,
            st_min: 99,
            st_max: 106,
            atr: 2.0,
            close: 102
        };
        
        // Calculate all distance metrics based on close price
        function calculateMetrics() {
            const c = marketStructure.close;
            const atr = marketStructure.atr;
            
            // Calculate 2-day range metrics
            const p2d_max = Math.max(marketStructure.daily_close, marketStructure.prev_daily_close);
            const p2d_min = Math.min(marketStructure.daily_close, marketStructure.prev_daily_close);
            const p2d_avg = (marketStructure.daily_close + marketStructure.prev_daily_close) / 2;
            const p2d_width = p2d_max - p2d_min;
            
            // Calculate ST width
            const st_width = marketStructure.st_max - marketStructure.st_min;
            
            return {
                dist_ema26: (c - marketStructure.ema26) / atr,
                dist_ema252: (c - marketStructure.ema252) / atr,
                dist_dh: (c - marketStructure.daily_high) / atr,
                dist_dl: (c - marketStructure.daily_low) / atr,
                dist_st_min: (c - marketStructure.st_min) / atr,
                dist_st_max: (c - marketStructure.st_max) / atr,
                dist_ema26_252: (marketStructure.ema26 - marketStructure.ema252) / atr,
                width_ratio: st_width > 0 ? p2d_width / st_width : 1.0,
                dist_p2d_avg: (c - p2d_avg) / atr,
                
                // Raw values for display
                raw: {
                    p2d_max,
                    p2d_min,
                    p2d_avg,
                    p2d_width,
                    st_width
                }
            };
        }
        
        // Bullish conditions with improved logic
        const bullishConditions = [
            {
                name: 'Strong Long-term Uptrend',
                check: (m) => m.dist_ema26_252 > 2.0,
                weight: 3,
                desc: 'EMA26 significantly above EMA252',
                metrics: ['dist_ema26_252']
            },
            {
                name: 'Moderate Long-term Uptrend',
                check: (m) => m.dist_ema26_252 > 1.0 && m.dist_ema26_252 <= 2.0,
                weight: 2,
                desc: 'EMA26 moderately above EMA252',
                metrics: ['dist_ema26_252']
            },
            {
                name: 'Price Above Long-term MA',
                check: (m) => m.dist_ema252 > 0,
                weight: 2,
                desc: 'Price trading above 252 EMA',
                metrics: ['dist_ema252']
            },
            {
                name: 'Strong Short-term Momentum',
                check: (m) => m.dist_ema26 > 0.8,
                weight: 3,
                desc: 'Price extended above EMA26',
                metrics: ['dist_ema26']
            },
            {
                name: 'Healthy Short-term Momentum',
                check: (m) => m.dist_ema26 > 0.3 && m.dist_ema26 <= 0.8,
                weight: 2,
                desc: 'Price moderately above EMA26',
                metrics: ['dist_ema26']
            },
            {
                name: 'Well Above ST Support',
                check: (m) => m.dist_st_min > 0.6,
                weight: 3,
                desc: 'Clear space from SuperTrend support',
                metrics: ['dist_st_min']
            },
            {
                name: 'Above ST Support',
                check: (m) => m.dist_st_min > 0.2 && m.dist_st_min <= 0.6,
                weight: 2,
                desc: 'Above SuperTrend support',
                metrics: ['dist_st_min']
            },
            {
                name: 'Room to Daily High',
                check: (m) => m.dist_dh < 0.5 && m.dist_dh > -0.2,
                weight: 2,
                desc: 'Not at resistance, upside available',
                metrics: ['dist_dh']
            },
            {
                name: 'Strong Position in Daily Range',
                check: (m) => m.dist_dl > 0.8,
                weight: 3,
                desc: 'Well above yesterday\'s low',
                metrics: ['dist_dl']
            },
            {
                name: 'Above Daily Support',
                check: (m) => m.dist_dl > 0.3 && m.dist_dl <= 0.8,
                weight: 2,
                desc: 'Above yesterday\'s low',
                metrics: ['dist_dl']
            },
            {
                name: 'Above 2-Day Average',
                check: (m) => m.dist_p2d_avg > 0.3,
                weight: 2,
                desc: 'Price above recent close average',
                metrics: ['dist_p2d_avg']
            },
            {
                name: 'Strong Range Expansion',
                check: (m) => m.width_ratio > 1.5,
                weight: 2,
                desc: 'Significant volatility expansion',
                metrics: ['width_ratio']
            },
            {
                name: 'Moderate Range Expansion',
                check: (m) => m.width_ratio > 1.3 && m.width_ratio <= 1.5,
                weight: 1,
                desc: 'Range expanding vs ST',
                metrics: ['width_ratio']
            },
            {
                name: 'Below ST Resistance',
                check: (m) => m.dist_st_max < -0.2,
                weight: 1,
                desc: 'Room to SuperTrend resistance',
                metrics: ['dist_st_max']
            }
        ];
        
        // Bearish conditions
        const bearishConditions = [
            {
                name: 'Strong Long-term Downtrend',
                check: (m) => m.dist_ema26_252 < -2.0,
                weight: 3,
                desc: 'EMA26 significantly below EMA252',
                metrics: ['dist_ema26_252']
            },
            {
                name: 'Moderate Long-term Downtrend',
                check: (m) => m.dist_ema26_252 < -1.0 && m.dist_ema26_252 >= -2.0,
                weight: 2,
                desc: 'EMA26 moderately below EMA252',
                metrics: ['dist_ema26_252']
            },
            {
                name: 'Price Below Long-term MA',
                check: (m) => m.dist_ema252 < 0,
                weight: 2,
                desc: 'Price trading below 252 EMA',
                metrics: ['dist_ema252']
            },
            {
                name: 'Strong Short-term Weakness',
                check: (m) => m.dist_ema26 < -0.8,
                weight: 3,
                desc: 'Price extended below EMA26',
                metrics: ['dist_ema26']
            },
            {
                name: 'Moderate Short-term Weakness',
                check: (m) => m.dist_ema26 < -0.3 && m.dist_ema26 >= -0.8,
                weight: 2,
                desc: 'Price moderately below EMA26',
                metrics: ['dist_ema26']
            },
            {
                name: 'Well Below ST Resistance',
                check: (m) => m.dist_st_max < -0.6,
                weight: 3,
                desc: 'Clear space from SuperTrend resistance',
                metrics: ['dist_st_max']
            },
            {
                name: 'Below ST Resistance',
                check: (m) => m.dist_st_max < -0.2 && m.dist_st_max >= -0.6,
                weight: 2,
                desc: 'Below SuperTrend resistance',
                metrics: ['dist_st_max']
            },
            {
                name: 'Room to Daily Low',
                check: (m) => m.dist_dl > -0.5 && m.dist_dl < 0.2,
                weight: 2,
                desc: 'Not at support, downside available',
                metrics: ['dist_dl']
            },
            {
                name: 'Weak Position in Daily Range',
                check: (m) => m.dist_dh < -0.8,
                weight: 3,
                desc: 'Well below yesterday\'s high',
                metrics: ['dist_dh']
            },
            {
                name: 'Below Daily Resistance',
                check: (m) => m.dist_dh < -0.3 && m.dist_dh >= -0.8,
                weight: 2,
                desc: 'Below yesterday\'s high',
                metrics: ['dist_dh']
            },
            {
                name: 'Below 2-Day Average',
                check: (m) => m.dist_p2d_avg < -0.3,
                weight: 2,
                desc: 'Price below recent close average',
                metrics: ['dist_p2d_avg']
            },
            {
                name: 'Strong Range Expansion',
                check: (m) => m.width_ratio > 1.5,
                weight: 2,
                desc: 'Significant volatility expansion',
                metrics: ['width_ratio']
            },
            {
                name: 'Moderate Range Expansion',
                check: (m) => m.width_ratio > 1.3 && m.width_ratio <= 1.5,
                weight: 1,
                desc: 'Range expanding vs ST',
                metrics: ['width_ratio']
            },
            {
                name: 'Above ST Support',
                check: (m) => m.dist_st_min > 0.2,
                weight: 1,
                desc: 'Room to SuperTrend support',
                metrics: ['dist_st_min']
            }
        ];
        
        // Update all displays
        function updateDisplay() {
            const metrics = calculateMetrics();
            
            // Update close price display
            document.getElementById('val_close').textContent = marketStructure.close.toFixed(1);
            
            // Update metrics grid
            updateMetricsGrid(metrics);
            
            // Calculate scores
            updateScores(metrics);
            
            // Update matrices
            updateMatrix('bullish', metrics);
            updateMatrix('bearish', metrics);
        }
        
        function updateMetricsGrid(metrics) {
            const grid = document.getElementById('metrics-grid');
            
            const metricsData = [
                { name: 'dist_ema26', label: 'Close vs EMA26', value: metrics.dist_ema26 },
                { name: 'dist_ema252', label: 'Close vs EMA252', value: metrics.dist_ema252 },
                { name: 'dist_dh', label: 'Close vs Daily High', value: metrics.dist_dh },
                { name: 'dist_dl', label: 'Close vs Daily Low', value: metrics.dist_dl },
                { name: 'dist_st_min', label: 'Close vs ST Support', value: metrics.dist_st_min },
                { name: 'dist_st_max', label: 'Close vs ST Resistance', value: metrics.dist_st_max },
                { name: 'dist_p2d_avg', label: 'Close vs 2D Avg', value: metrics.dist_p2d_avg },
                { name: 'dist_ema26_252', label: 'EMA26 vs EMA252', value: metrics.dist_ema26_252 },
                { name: 'width_ratio', label: '2D Width / ST Width', value: metrics.width_ratio }
            ];
            
            let html = '';
            metricsData.forEach(m => {
                const className = m.value > 0.2 ? 'positive' : m.value < -0.2 ? 'negative' : 'neutral';
                const sign = m.value > 0 ? '+' : '';
                html += `
                    <div class="value-card ${className}">
                        <div class="value-label">${m.label}</div>
                        <div class="value-number">${sign}${m.value.toFixed(2)}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function updateScores(metrics) {
            // Calculate bullish score
            let bullishScore = 0;
            let bullishMax = 0;
            let bullishHtml = '';
            
            bullishConditions.forEach(cond => {
                const met = cond.check(metrics);
                bullishMax += cond.weight;
                if (met) bullishScore += cond.weight;
                
                const metricsUsed = cond.metrics.map(m => {
                    const val = metrics[m];
                    return `${m}: ${val >= 0 ? '+' : ''}${val.toFixed(2)}`;
                }).join(', ');
                
                bullishHtml += `
                    <div class="condition-item ${met ? 'met' : 'not-met'}">
                        <span class="condition-icon">${met ? '‚úÖ' : '‚ùå'}</span>
                        <div style="flex: 1;">
                            <strong>${cond.name}</strong>
                            <div style="font-size: 0.85em; opacity: 0.8;">${cond.desc}</div>
                            <div style="font-size: 0.75em; opacity: 0.6; margin-top: 3px;">${metricsUsed}</div>
                        </div>
                        <span class="condition-weight">+${cond.weight}</span>
                    </div>
                `;
            });
            
            const bullishPercent = (bullishScore / bullishMax * 100).toFixed(0);
            document.getElementById('bullish-score').textContent = bullishPercent + '%';
            document.getElementById('bullish-bar').style.width = bullishPercent + '%';
            document.getElementById('bullish-bar').textContent = bullishPercent + '%';
            document.getElementById('bullish-conditions').innerHTML = bullishHtml;
            
            // Calculate bearish score
            let bearishScore = 0;
            let bearishMax = 0;
            let bearishHtml = '';
            
            bearishConditions.forEach(cond => {
                const met = cond.check(metrics);
                bearishMax += cond.weight;
                if (met) bearishScore += cond.weight;
                
                const metricsUsed = cond.metrics.map(m => {
                    const val = metrics[m];
                    return `${m}: ${val >= 0 ? '+' : ''}${val.toFixed(2)}`;
                }).join(', ');
                
                bearishHtml += `
                    <div class="condition-item ${met ? 'met' : 'not-met'}">
                        <span class="condition-icon">${met ? '‚úÖ' : '‚ùå'}</span>
                        <div style="flex: 1;">
                            <strong>${cond.name}</strong>
                            <div style="font-size: 0.85em; opacity: 0.8;">${cond.desc}</div>
                            <div style="font-size: 0.75em; opacity: 0.6; margin-top: 3px;">${metricsUsed}</div>
                        </div>
                        <span class="condition-weight">+${cond.weight}</span>
                    </div>
                `;
            });
            
            const bearishPercent = (bearishScore / bearishMax * 100).toFixed(0);
            document.getElementById('bearish-score').textContent = bearishPercent + '%';
            document.getElementById('bearish-bar').style.width = bearishPercent + '%';
            document.getElementById('bearish-bar').textContent = bearishPercent + '%';
            document.getElementById('bearish-conditions').innerHTML = bearishHtml;
        }
        
        function updateMatrix(type, metrics) {
            const matrix = document.getElementById(`${type}-matrix`);
            const conditions = type === 'bullish' ? bullishConditions : bearishConditions;
            
            const allMetrics = [
                'dist_ema26', 'dist_ema252', 'dist_dh', 'dist_dl', 
                'dist_st_min', 'dist_st_max', 'dist_p2d_avg', 
                'dist_ema26_252', 'width_ratio'
            ];
            
            // Build header
            let html = '<thead><tr><th class="row-header">Condition</th>';
            allMetrics.forEach(m => {
                const shortName = m.replace('dist_', '').replace('_', ' ');
                html += `<th>${shortName}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Build rows
            conditions.forEach(cond => {
                html += `<tr><td class="row-header">${cond.name}</td>`;
                
                allMetrics.forEach(metricName => {
                    // Test correlation by simulating metric changes
                    const currentValue = metrics[metricName];
                    const originalMet = cond.check(metrics);
                    
                    // Create test scenarios
                    const testMetrics = {...metrics};
                    
                    // Test increasing the metric
                    testMetrics[metricName] = currentValue + 1.0;
                    const increasedMet = cond.check(testMetrics);
                    
                    // Test decreasing the metric
                    testMetrics[metricName] = currentValue - 1.0;
                    const decreasedMet = cond.check(testMetrics);
                    
                    // Determine correlation strength
                    let correlation = 0;
                    
                    // Check if this metric is directly used in the condition
                    const isDirectMetric = cond.metrics.includes(metricName);
                    
                    if (isDirectMetric) {
                        // For bullish conditions
                        if (type === 'bullish') {
                            if (increasedMet && !originalMet) correlation = 2;
                            else if (increasedMet && originalMet) correlation = 1;
                            else if (!decreasedMet && originalMet) correlation = 2;
                            else if (decreasedMet && !originalMet) correlation = -2;
                            else if (!increasedMet && originalMet) correlation = -1;
                        }
                        // For bearish conditions
                        else {
                            if (decreasedMet && !originalMet) correlation = 2;
                            else if (decreasedMet && originalMet) correlation = 1;
                            else if (!increasedMet && originalMet) correlation = 2;
                            else if (increasedMet && !originalMet) correlation = -2;
                            else if (!decreasedMet && originalMet) correlation = -1;
                        }
                    } else {
                        // Indirect relationship
                        if (increasedMet && !originalMet) correlation = 1;
                        else if (decreasedMet && !originalMet) correlation = -1;
                    }
                    
                    // Determine cell class and symbol
                    let cellClass = 'cell-neutral';
                    let symbol = '‚óã';
                    
                    if (correlation >= 2) {
                        cellClass = 'cell-strong-bull';
                        symbol = '++';
                    } else if (correlation === 1) {
                        cellClass = 'cell-bull';
                        symbol = '+';
                    } else if (correlation <= -2) {
                        cellClass = 'cell-strong-bear';
                        symbol = '--';
                    } else if (correlation === -1) {
                        cellClass = 'cell-bear';
                        symbol = '-';
                    }
                    
                    html += `<td class="${cellClass}">${symbol}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            matrix.innerHTML = html;
        }
        
        // Event listeners for market structure inputs
        function setupEventListeners() {
            // Price slider
            document.getElementById('close_price').addEventListener('input', (e) => {
                marketStructure.close = parseFloat(e.target.value);
                updateDisplay();
            });
            
            // Market structure inputs
            const structureInputs = [
                'ema26', 'ema252', 'daily_high', 'daily_low', 
                'daily_close', 'prev_daily_close', 'st_min', 'st_max', 'atr'
            ];
            
            structureInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    if (!isNaN(value) && value > 0) {
                        marketStructure[id] = value;
                        
                        // Auto-adjust close price slider range based on structure
                        const minPrice = Math.min(
                            marketStructure.ema252,
                            marketStructure.daily_low,
                            marketStructure.st_min
                        ) - 10;
                        
                        const maxPrice = Math.max(
                            marketStructure.ema252,
                            marketStructure.daily_high,
                            marketStructure.st_max
                        ) + 10;
                        
                        const closeSlider = document.getElementById('close_price');
                        closeSlider.min = minPrice.toFixed(0);
                        closeSlider.max = maxPrice.toFixed(0);
                        
                        // Keep close within valid range
                        if (marketStructure.close < minPrice) {
                            marketStructure.close = minPrice;
                            closeSlider.value = minPrice;
                        } else if (marketStructure.close > maxPrice) {
                            marketStructure.close = maxPrice;
                            closeSlider.value = maxPrice;
                        }
                        
                        updateDisplay();
                    }
                });
            });
        }
        
        // Initialize
        setupEventListeners();
        updateDisplay();
    </script>
</body>
</html>